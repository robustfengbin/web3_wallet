# Zcash Orchard éšç§é’±åŒ… Chrome æ’ä»¶æŠ€æœ¯æ–¹æ¡ˆ

## 1. æ¦‚è¿°

### 1.1 ç›®æ ‡

å°†ç°æœ‰çš„ Zcash Orchard éšç§é’±åŒ…æœåŠ¡æ”¹é€ ä¸º Chrome æµè§ˆå™¨æ’ä»¶ï¼Œç¡®ä¿ï¼š
- **å¯†é’¥å®‰å…¨**: æ‰€æœ‰ç§é’¥åœ¨æœ¬åœ°å­˜å‚¨å’Œç®¡ç†ï¼Œæ°¸ä¸ä¸Šä¼ æœåŠ¡å™¨
- **éšç§ä¿æŠ¤**: ä¿æŒ Zcash Orchard çš„é›¶çŸ¥è¯†è¯æ˜éšç§ç‰¹æ€§
- **ç”¨æˆ·ä½“éªŒ**: æä¾›ç±»ä¼¼ MetaMask çš„ä¾¿æ·æ“ä½œä½“éªŒ

### 1.2 æ ¸å¿ƒæŒ‘æˆ˜

| æŒ‘æˆ˜ | ç°æœ‰æ–¹æ¡ˆ | æ’ä»¶æ–¹æ¡ˆ |
|------|---------|---------|
| å¯†é’¥å­˜å‚¨ | MySQL + AES-256-GCM | Chrome Storage + Web Crypto API |
| è¯æ˜ç”Ÿæˆ | Rust åŸç”Ÿ (20ç§’) | WASM (éœ€ä¼˜åŒ–) |
| åŒºå—åŒæ­¥ | å®Œæ•´ RPC èŠ‚ç‚¹ | Lightwalletd è½»å®¢æˆ·ç«¯ |
| è§è¯äººæ•°æ® | æœåŠ¡å™¨å­˜å‚¨ | IndexedDB æœ¬åœ°å­˜å‚¨ |

---

## 2. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Chrome Extension                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Popup UI   â”‚  â”‚  Options UI  â”‚  â”‚      Content Script      â”‚   â”‚
â”‚  â”‚  (React/Vue) â”‚  â”‚   (è®¾ç½®é¡µ)   â”‚  â”‚   (DApp äº¤äº’æ³¨å…¥)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                 â”‚                        â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                          â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Background Service Worker                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ KeyManager  â”‚ â”‚ TxBuilder   â”‚ â”‚  WitnessSync Manager    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (å¯†é’¥ç®¡ç†)  â”‚ â”‚ (äº¤æ˜“æ„å»º)  â”‚ â”‚   (è§è¯äººåŒæ­¥)          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚         â”‚               â”‚                     â”‚                â”‚  â”‚
â”‚  â”‚         â–¼               â–¼                     â–¼                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚              Orchard WASM Core (Rustâ†’WASM)            â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - å¯†é’¥æ´¾ç”Ÿ (BIP-44/ZIP-32)                           â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - åœ°å€ç”Ÿæˆ (Unified Address)                         â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - è¯æ˜ç”Ÿæˆ (Halo 2)                                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - Notes è§£å¯†                                         â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¤–éƒ¨æœåŠ¡å±‚                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Lightwalletd   â”‚  â”‚  Block Explorer â”‚  â”‚   Price Service    â”‚   â”‚
â”‚  â”‚  (è½»èŠ‚ç‚¹æœåŠ¡)   â”‚  â”‚  (äº¤æ˜“æŸ¥è¯¢)     â”‚  â”‚   (ä»·æ ¼æŸ¥è¯¢)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ¬åœ°å­˜å‚¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ chrome.storage  â”‚  â”‚    IndexedDB    â”‚  â”‚    Web Crypto      â”‚   â”‚
â”‚  â”‚  - åŠ å¯†ç§é’¥     â”‚  â”‚  - Notes æ•°æ®   â”‚  â”‚  - å¯†é’¥æ´¾ç”Ÿ        â”‚   â”‚
â”‚  â”‚  - è®¾ç½®         â”‚  â”‚  - è§è¯äººçŠ¶æ€   â”‚  â”‚  - åŠ å¯†/è§£å¯†       â”‚   â”‚
â”‚  â”‚  - åœ°å€ç°¿       â”‚  â”‚  - åŒæ­¥çŠ¶æ€     â”‚  â”‚                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç›®å½•ç»“æ„

```
zcash-orchard-wallet-extension/
â”œâ”€â”€ manifest.json                    # Chrome Extension Manifest V3
â”œâ”€â”€ package.json
â”œâ”€â”€ webpack.config.js
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ background/                  # Service Worker (æ ¸å¿ƒåå°)
â”‚   â”‚   â”œâ”€â”€ index.ts                 # å…¥å£
â”‚   â”‚   â”œâ”€â”€ keyManager.ts            # å¯†é’¥ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ walletController.ts      # é’±åŒ…æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ txBuilder.ts             # äº¤æ˜“æ„å»º
â”‚   â”‚   â”œâ”€â”€ syncManager.ts           # åŒæ­¥ç®¡ç†
â”‚   â”‚   â””â”€â”€ messageHandler.ts        # æ¶ˆæ¯å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ popup/                       # Popup UI
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â””â”€â”€ pages/
â”‚   â”‚       â”œâ”€â”€ Unlock.tsx           # è§£é”é¡µé¢
â”‚   â”‚       â”œâ”€â”€ Dashboard.tsx        # ä¸»é¢æ¿
â”‚   â”‚       â”œâ”€â”€ Send.tsx             # å‘é€
â”‚   â”‚       â”œâ”€â”€ Receive.tsx          # æ¥æ”¶
â”‚   â”‚       â””â”€â”€ Settings.tsx         # è®¾ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                        # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ crypto/
â”‚   â”‚   â”‚   â”œâ”€â”€ keyDerivation.ts     # å¯†é’¥æ´¾ç”Ÿ
â”‚   â”‚   â”‚   â””â”€â”€ encryption.ts        # åŠ å¯†å·¥å…·
â”‚   â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”‚   â”œâ”€â”€ secureStorage.ts     # å®‰å…¨å­˜å‚¨
â”‚   â”‚   â”‚   â””â”€â”€ indexedDB.ts         # IndexedDB æ“ä½œ
â”‚   â”‚   â””â”€â”€ network/
â”‚   â”‚       â””â”€â”€ lightClient.ts       # Lightwalletd å®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â””â”€â”€ wasm/                        # Rust WASM æ¨¡å—
â”‚       â”œâ”€â”€ Cargo.toml
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ lib.rs               # WASM å…¥å£
â”‚           â”œâ”€â”€ keys.rs              # å¯†é’¥æ“ä½œ
â”‚           â”œâ”€â”€ address.rs           # åœ°å€ç”Ÿæˆ
â”‚           â”œâ”€â”€ proof.rs             # è¯æ˜ç”Ÿæˆ
â”‚           â””â”€â”€ transaction.rs       # äº¤æ˜“æ„å»º
â”‚
â””â”€â”€ public/
    â”œâ”€â”€ popup.html
    â””â”€â”€ icons/
```

---

## 3. å¯†é’¥ç®¡ç†æ–¹æ¡ˆ

### 3.1 å¯†é’¥æ´¾ç”Ÿä½“ç³»

```
                    ç”¨æˆ·å¯†ç  (User Password)
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     Argon2id (å¯†ç å“ˆå¸Œ)       â”‚
              â”‚  memory: 64MB, iterations: 3  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    å¯†ç æ´¾ç”Ÿå¯†é’¥ (PDK)
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
              â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  åŠ å¯†ä¸»å¯†é’¥     â”‚             â”‚  åŠ å¯†ç§å­       â”‚
    â”‚  (AES-256-GCM)  â”‚             â”‚  (AES-256-GCM)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â–¼                               â–¼
    è§£å¯†åçš„ä¸»å¯†é’¥                   è§£å¯†åçš„ç§å­ (BIP-39)
             â”‚                               â”‚
             â”‚                               â–¼
             â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                    â”‚    ZIP-32 æ´¾ç”Ÿ       â”‚
             â”‚                    â”‚  m/32'/133'/0'       â”‚
             â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚      â”‚                        â”‚                        â”‚
             â”‚      â–¼                        â–¼                        â–¼
             â”‚  Orchard SK              Sapling SK              Transparent SK
             â”‚  (æ”¯å‡ºå¯†é’¥)              (æ”¯å‡ºå¯†é’¥)              (secp256k1)
             â”‚      â”‚                        â”‚                        â”‚
             â”‚      â–¼                        â–¼                        â–¼
             â”‚  Orchard FVK             Sapling FVK              Public Key
             â”‚  (æŸ¥çœ‹å¯†é’¥)              (æŸ¥çœ‹å¯†é’¥)                   â”‚
             â”‚      â”‚                        â”‚                        â”‚
             â”‚      â–¼                        â–¼                        â–¼
             â””â”€â–º Unified Address (u1...) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 åŒ…å«å¤šä¸ªæ¥æ”¶å™¨
```

### 3.2 å¯†é’¥å­˜å‚¨ç»“æ„

```typescript
// å­˜å‚¨åœ¨ chrome.storage.local (åŠ å¯†å)
interface EncryptedVault {
  version: number;                    // ç‰ˆæœ¬å·ï¼Œç”¨äºè¿ç§»
  salt: string;                       // Argon2 salt (base64)
  nonce: string;                      // AES-GCM nonce (base64)
  encryptedSeed: string;              // åŠ å¯†çš„ç§å­ (base64)
  encryptedAccounts: string;          // åŠ å¯†çš„è´¦æˆ·æ•°æ® (base64)
  checksum: string;                   // å®Œæ•´æ€§æ ¡éªŒ
  createdAt: number;
  lastUnlockedAt: number;
}

// è§£å¯†åçš„è´¦æˆ·æ•°æ®
interface DecryptedAccount {
  index: number;                      // è´¦æˆ·ç´¢å¼•
  name: string;                       // è´¦æˆ·åç§°
  orchardSK: Uint8Array;              // Orchard æ”¯å‡ºå¯†é’¥
  orchardFVK: Uint8Array;             // Orchard æŸ¥çœ‹å¯†é’¥
  transparentSK: Uint8Array;          // é€æ˜åœ°å€ç§é’¥
  unifiedAddress: string;             // ç»Ÿä¸€åœ°å€ (u1...)
  birthdayHeight: number;             // æ‰«æèµ·å§‹é«˜åº¦
}

// å†…å­˜ä¸­çš„ä¼šè¯çŠ¶æ€ (ä¸æŒä¹…åŒ–)
interface SessionState {
  isUnlocked: boolean;
  passwordDerivedKey: CryptoKey | null;
  decryptedAccounts: DecryptedAccount[];
  lockTimeout: number;                // è‡ªåŠ¨é”å®šæ—¶é—´
  lastActivity: number;
}
```

### 3.3 å®‰å…¨ç­–ç•¥

| å®‰å…¨æªæ–½ | å®ç°æ–¹å¼ |
|---------|---------|
| å¯†ç å¼ºåº¦ | æœ€å°‘ 12 å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™+æ•°å­—+ç‰¹æ®Šå­—ç¬¦ |
| å¯†é’¥æ´¾ç”Ÿ | Argon2id (64MB å†…å­˜ï¼Œé˜² ASIC) |
| åŠ å¯†ç®—æ³• | AES-256-GCM (AEAD è®¤è¯åŠ å¯†) |
| è‡ªåŠ¨é”å®š | 5/15/30 åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨é”å®š |
| ä¼šè¯å¯†é’¥ | ä»…å­˜å†…å­˜ï¼Œé¡µé¢å…³é—­å³æ¸…é™¤ |
| ç§é’¥è®¿é—® | ä»…åœ¨ç­¾åæ—¶ä¸´æ—¶è§£å¯†ï¼Œç”¨å®Œå³é”€æ¯ |
| å¤‡ä»½åŠ å¯† | å¯¼å‡ºçš„å¤‡ä»½æ–‡ä»¶åŒæ ·åŠ å¯† |

---

## 4. WASM æ ¸å¿ƒæ¨¡å—

### 4.1 Rust WASM ç¼–è¯‘

```toml
# src/wasm/Cargo.toml

[package]
name = "zcash-orchard-wasm"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib", "rlib"]

[dependencies]
wasm-bindgen = "0.2"
js-sys = "0.3"
web-sys = { version = "0.3", features = ["console"] }
getrandom = { version = "0.2", features = ["js"] }
serde = { version = "1.0", features = ["derive"] }
serde-wasm-bindgen = "0.6"

# Zcash æ ¸å¿ƒåº“
orchard = "0.11"
zcash_primitives = "0.26"
zcash_protocol = "0.7"
zcash_note_encryption = "0.4"
zcash_address = "0.10"
pasta_curves = "0.5"

# å¯†ç å­¦
blake2b_simd = "1.0"
secp256k1 = { version = "0.28", features = ["alloc"] }

# å¹¶å‘ (ç”¨äºè¯æ˜ç”Ÿæˆ)
rayon = "1.10"
wasm-bindgen-rayon = "1.0"

[profile.release]
lto = true
opt-level = "s"
panic = "abort"
```

### 4.2 WASM æ¥å£è®¾è®¡

```rust
// src/wasm/src/lib.rs

use wasm_bindgen::prelude::*;
use orchard::{
    keys::{SpendingKey, FullViewingKey, PreparedIncomingViewingKey},
    builder::{Builder, BundleType},
};

#[wasm_bindgen]
pub struct OrchardWallet {
    spending_key: Option<SpendingKey>,
    viewing_key: FullViewingKey,
    prepared_ivk: PreparedIncomingViewingKey,
}

#[wasm_bindgen]
impl OrchardWallet {
    /// ä»ç§å­åˆ›å»ºé’±åŒ…
    #[wasm_bindgen(constructor)]
    pub fn from_seed(seed: &[u8], account_index: u32) -> Result<OrchardWallet, JsError> {
        let sk = SpendingKey::from_zip32_seed(seed, 0x85, account_index)
            .map_err(|e| JsError::new(&format!("Failed to derive spending key: {:?}", e)))?;

        let fvk = FullViewingKey::from(&sk);
        let prepared_ivk = PreparedIncomingViewingKey::new(
            &fvk.to_ivk(orchard::keys::Scope::External)
        );

        Ok(OrchardWallet {
            spending_key: Some(sk),
            viewing_key: fvk,
            prepared_ivk,
        })
    }

    /// ç”Ÿæˆç»Ÿä¸€åœ°å€
    #[wasm_bindgen]
    pub fn get_unified_address(&self) -> String {
        let receiver = self.viewing_key.address_at(
            0u32,
            orchard::keys::Scope::External
        );
        // è¿”å›ç»Ÿä¸€åœ°å€å­—ç¬¦ä¸²
        format!("u1...")
    }

    /// æ„å»ºå¹¶ç­¾ç½²äº¤æ˜“
    #[wasm_bindgen]
    pub fn build_transaction(
        &self,
        spends: JsValue,
        outputs: JsValue,
        anchor: &[u8],
    ) -> Result<Vec<u8>, JsError> {
        let sk = self.spending_key.as_ref()
            .ok_or_else(|| JsError::new("Spending key not available"))?;

        // æ„å»ºäº¤æ˜“...
        // ç”Ÿæˆ Halo 2 è¯æ˜...
        // ç­¾ç½²...

        Ok(vec![])
    }
}
```

### 4.3 è¯æ˜ç”Ÿæˆä¼˜åŒ–

| ç­–ç•¥ | è¯´æ˜ |
|------|------|
| Web Worker | éš”ç¦»è¯æ˜ç”Ÿæˆï¼Œä¸é˜»å¡ UI |
| SIMD | ä½¿ç”¨ WebAssembly SIMD åŠ é€Ÿ |
| å¹¶è¡Œè®¡ç®— | wasm-bindgen-rayon å¤šçº¿ç¨‹ |
| è¯æ˜ç¼“å­˜ | ç¼“å­˜ proving key (~40MB) |
| è¿›åº¦å›è°ƒ | å®æ—¶æ˜¾ç¤ºè¯æ˜ç”Ÿæˆè¿›åº¦ |

---

## 5. è½»å®¢æˆ·ç«¯åŒæ­¥

### 5.1 Lightwalletd é›†æˆ

ä½¿ç”¨ Zcash Lightwalletd gRPC åè®®æ›¿ä»£å®Œæ•´ RPCï¼š

```protobuf
// ä¸»è¦ä½¿ç”¨çš„ gRPC æ¥å£
service CompactTxStreamer {
  rpc GetLatestBlock(ChainSpec) returns (BlockID);
  rpc GetBlockRange(BlockRange) returns (stream CompactBlock);
  rpc GetTransaction(TxFilter) returns (RawTransaction);
  rpc SendTransaction(RawTransaction) returns (SendResponse);
  rpc GetTreeState(BlockID) returns (TreeState);
}
```

### 5.2 åŒæ­¥æµç¨‹

```
1. åˆå§‹åŒ–
   æ£€æŸ¥åŒæ­¥çŠ¶æ€ â†’ IndexedDB.get('syncState')
           â†“
   è·å–æœ€æ–°é«˜åº¦ â†’ Lightwalletd.GetLatestBlock()
           â†“
2. å¢é‡åŒæ­¥
   æ‰¹é‡è·å–å‹ç¼©å— â†’ Lightwalletd.GetBlockRange()
           â†“
   è§£æ CompactBlock
     for each block:
       for each tx:
         for each OrchardAction:
           if (WASM.tryDecrypt(action, ivk)):
             saveNote(decryptedNote)
             updateWitness(note.position)
           â†“
3. æ›´æ–°è§è¯äºº
   è¿½åŠ æ–°çš„ commitments åˆ°æœ¬åœ°æ ‘
   ä¸ºæ¯ä¸ªæœªèŠ±è´¹ note æ›´æ–° auth path
           â†“
4. æ£€æµ‹å·²èŠ±è´¹
   for each spentNullifier:
     if (localNotes.has(nullifier)):
       markAsSpent(nullifier)
           â†“
5. ä¿å­˜çŠ¶æ€
   IndexedDB.put('syncState', {...})
```

### 5.3 æœ¬åœ°å­˜å‚¨æ¨¡å‹

```typescript
// IndexedDB Schema
interface OrchardSyncDB {
  syncState: {
    walletId: string;
    lastScannedHeight: number;
    treeSize: number;
    treeRoot: Uint8Array;
    updatedAt: number;
  };

  notes: {
    id: string;                       // nullifier hex
    walletId: string;
    txHash: string;
    blockHeight: number;
    value: number;
    recipient: Uint8Array;
    position: number;
    isSpent: boolean;
    createdAt: number;
  };

  witnesses: {
    noteId: string;
    position: number;
    authPath: Uint8Array;
    root: Uint8Array;
    height: number;
  };
}
```

---

## 6. ç”¨æˆ·ç•Œé¢

### 6.1 ä¸»ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ğŸ”’ Zcash Orchard Wallet         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Account 1                      â–¼   â”‚
â”‚  u1abc...xyz            [ğŸ“‹ Copy]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚        ğŸ’° 12.5432 ZEC               â”‚
â”‚        $245.67 USD                  â”‚
â”‚                                     â”‚
â”‚  ğŸ›¡ï¸ Shielded:    10.0000 ZEC        â”‚
â”‚  ğŸ“Š Transparent:  2.5432 ZEC        â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Send   â”‚  â”‚   Receive    â”‚    â”‚
â”‚  â”‚    â¡ï¸    â”‚  â”‚      â¬…ï¸      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Recent Transactions                â”‚
â”‚  âœ“ Received +1.5 ZEC (2h ago)      â”‚
â”‚  âœ“ Sent -0.5 ZEC (Yesterday)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš™ï¸ Settings   |   ğŸ”„ Sync: OK      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å®‰å…¨è®¾è®¡

### 7.1 å¨èƒæ¨¡å‹

| å¨èƒ | ç¼“è§£æªæ–½ |
|------|---------|
| XSS æ”»å‡» | Content Security Policy ä¸¥æ ¼é™åˆ¶ |
| æ¶æ„æ‰©å±• | æœ€å°æƒé™åŸåˆ™ |
| å†…å­˜è¯»å– | æ•æ„Ÿæ•°æ®ç”¨å®Œå³æ¸… |
| é’“é±¼æ”»å‡» | åŸŸåç™½åå•ï¼Œå®Œæ•´åœ°å€æ˜¾ç¤º |
| ä¾›åº”é“¾æ”»å‡» | ä¾èµ–å®¡è®¡ï¼Œç­¾åéªŒè¯ |

### 7.2 Manifest V3 é…ç½®

```json
{
  "manifest_version": 3,
  "name": "Zcash Orchard Wallet",
  "version": "1.0.0",

  "permissions": [
    "storage",
    "alarms"
  ],

  "host_permissions": [
    "https://*.lightwalletd.com/*"
  ],

  "background": {
    "service_worker": "background.js",
    "type": "module"
  },

  "content_security_policy": {
    "extension_pages": "script-src 'self' 'wasm-unsafe-eval'; object-src 'self'"
  }
}
```

---

## 8. å¼€å‘è®¡åˆ’

### 8.1 é˜¶æ®µåˆ’åˆ†

| é˜¶æ®µ | å†…å®¹ | å‘¨æœŸ |
|------|------|------|
| 1 | åŸºç¡€æ¶æ„ (Extension æ­å»º) | 4 å‘¨ |
| 2 | å¯†é’¥ç®¡ç† (Argon2id + AES) | 3 å‘¨ |
| 3 | WASM æ ¸å¿ƒ (Rust ç¼–è¯‘) | 4 å‘¨ |
| 4 | è½»å®¢æˆ·ç«¯åŒæ­¥ | 3 å‘¨ |
| 5 | ç”¨æˆ·ç•Œé¢ | 3 å‘¨ |
| 6 | æµ‹è¯•ä¸å®‰å…¨å®¡è®¡ | 2 å‘¨ |
| 7 | å‘å¸ƒ | 1 å‘¨ |

### 8.2 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ |
|------|---------|
| UI æ¡†æ¶ | React 18 + TypeScript |
| çŠ¶æ€ç®¡ç† | Zustand |
| æ ·å¼ | Tailwind CSS |
| æ„å»ºå·¥å…· | Vite + CRXJS |
| WASM | Rust + wasm-bindgen |
| å­˜å‚¨ | chrome.storage + IndexedDB |
| ç½‘ç»œ | gRPC-web |
| å¯†ç å­¦ | @noble/hashes + @noble/ciphers |

---

## 9. æ³¨æ„äº‹é¡¹

### 9.1 å·²çŸ¥é™åˆ¶

1. **è¯æ˜ç”Ÿæˆæ—¶é—´**: WASM ä¸­å¯èƒ½éœ€è¦ 60-120 ç§’
2. **å­˜å‚¨å¤§å°**: chrome.storage.local é™åˆ¶ 10MB
3. **é¦–æ¬¡åŒæ­¥**: å¯èƒ½éœ€è¦æ•°å°æ—¶
4. **å†…å­˜å ç”¨**: è¯æ˜ç”Ÿæˆå¯èƒ½éœ€è¦ 2GB+ å†…å­˜

### 9.2 ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»

Chrome æ’ä»¶ä¸ç°æœ‰åç«¯æœåŠ¡å¯ä»¥**å…±å­˜**ï¼š

- **æ’ä»¶**: é¢å‘ä¸ªäººç”¨æˆ·ï¼Œå¯†é’¥æœ¬åœ°ç®¡ç†
- **åç«¯æœåŠ¡**: é¢å‘ä¼ä¸š/æœºæ„ï¼Œä¸­å¿ƒåŒ–å¯†é’¥ç®¡ç†

---

## 10. å‚è€ƒèµ„æº

- [Zcash Protocol Specification](https://zips.z.cash/protocol/protocol.pdf)
- [ZIP-32: Shielded Hierarchical Deterministic Wallets](https://zips.z.cash/zip-0032)
- [Orchard Crate Documentation](https://docs.rs/orchard)
- [Chrome Extension Manifest V3](https://developer.chrome.com/docs/extensions/mv3/)
- [Lightwalletd gRPC Protocol](https://github.com/zcash/lightwalletd)
